<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qonnect - Search Connection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    
    <!-- Swiper CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <link rel="stylesheet" href="static/css/style.css">

    <style>
      /* Enforce consistent dimensions for all employee cards */
      .unified-card {
        width: 220px;
        height: 195px;
        position: relative; /* Positioning context for badges */
      }
      
      /* Ensure the swiper slide respects the card's width */
      .swiper-slide {
        width: auto;
      }

      /* Connection badge styles */
      .connection-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 600;
        border-radius: 9999px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 10;
      }

      .badge-strong {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
      }

      .badge-medium {
        background-color: #fef9c3;
        color: #854d0e;
        border: 1px solid #fcd34d;
      }

      .badge-weak {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }

      /* Tree view styles for expanded hierarchy */
      .tree-node > .node-wrapper {
        display: flex;
        align-items: center;
        position: relative;
      }

      .qt-overlay-container {
        position: absolute;
        right: 100%;
        top: 0;
        height: 100%;
        display: flex;
        align-items: center;
        z-index: 5;
      }

      .qt-connection-line-dynamic {
        width: 5rem;
        height: 5px;
      }

      .line-strong {
        background-color: #86efac;
      }
      
      .line-medium {
        background-color: #fcd34d;
      }
      
      .line-weak {
        background-color: #fca5a5;
      }
    </style>
  </head>
  
  <body class="bg-gray-50 text-gray-900">
    <nav class="w-full p-4 border-b border-gray-200 bg-[#212559] backdrop-blur-sm sticky top-0 z-40">
      <div class="container mx-auto flex items-center justify-between">
        <a href="/" class="flex items-center gap-5">
          <i class="fas fa-project-diagram text-2xl text-primary text-white"></i>
          <h1 class="text-2xl font-bold text-white">Qonnect</h1>
        </a>
      </div>
    </nav>

    <div class="max-w-7xl p-8 mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold">Organization Hierarchy Chart</h1>
        <p class="muted mt-2">Search for Google employees to find the shortest connection path from the QT team.</p>
      </div>

      <div class="flex justify-center mb-8">
        <div class="relative w-full max-w-md">
          <div class="relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
            <input type="text" id="searchInput" placeholder="Search Google employees..." class="input pl-10" />
          </div>
          <div id="suggestions" class="suggestions hidden"></div>
        </div>
      </div>

      <div id="mainContent">
        <div class="text-center muted py-16">
          <p>Search and select a Google employee to view their hierarchy and connections.</p>
        </div>
      </div>
    </div>

    <script>
      // Data
      let googleEmployees = [];
      let coreTeam = [];
      const connectionPaths = {};

      // Global state
      let selectedEmployee = null;
      let expandedConnection = null;
      let summarySwiperInstance = null;
      const employeeMap = new Map();

      // Load data from Flask API
      async function loadFlaskData() {
        try {
          console.log('ðŸ”„ Loading data from Flask API...');
          
          const googleResponse = await fetch('/api/google-employees');
          const data = await googleResponse.json();
          googleEmployees = data.map(emp => ({
            ldap: emp.ldap,
            email: emp.email || emp.ldap + '@google.com',
            // FIXED: Use MOMA Photo URL from sheet instead of placeholder
            avatar: emp['MOMA Photo URL'] || emp.avatar || null,
            name: emp.name,
            company: emp.company || "GOOGLE",
            designation: emp.designation,
            organisation: emp.organisation || emp.department || "Google",
            manager: emp.manager || null,
          }));

          const qtResponse = await fetch('/api/qt-team');
          const qtData = await qtResponse.json();
          coreTeam = qtData.map(emp => ({
            ldap: emp.ldap,
            email: emp.email || emp.ldap + '@qualitestgroup.com',
            avatar: emp.avatar || `https://i.pravatar.cc/150?u=${emp.ldap}`,
            name: emp.name,
            company: emp.company || "QT",
            designation: emp.designation,
            organisation: emp.organisation || emp.department || "QT",
            connections: emp.connections || [],
          }));
          
          console.log('âœ… API data loaded successfully');
          console.log('ðŸ“Š Google employees loaded:', googleEmployees.length);
          console.log('ðŸ“Š QT team loaded:', coreTeam.length);
          
        } catch (error) {
          console.log('âš ï¸ API not available, using sample data');
          console.error('API Error:', error);
          
          // Fallback sample data based on your actual sheet structure
          googleEmployees = [
            {
              ldap: "ashwink",
              email: "ashwink@google.com",
              avatar: "https://i.pravatar.cc/150?u=ashwink",
              name: "Ashwin Kakarla",
              company: "GOOGLE",
              designation: "Senior Program Manager (L7)",
              organisation: "Google",
              manager: null,
            },
            {
              ldap: "hackerj",
              email: "hackerj@google.com", 
              avatar: "https://i.pravatar.cc/150?u=hackerj",
              name: "Hacker",
              company: "GOOGLE",
              designation: "Analyst",
              organisation: "Google Engineering",
              manager: "ashwink@google.com",
            },
            {
              ldap: "adapally",
              email: "adapally@google.com",
              avatar: "https://i.pravatar.cc/150?u=adapally", 
              name: "A Aarathi",
              company: "GOOGLE",
              designation: "Analyst",
              organisation: "Google Engineering",
              manager: "ashwink@google.com",
            },
          ];

          coreTeam = [
            {
              ldap: 'lihis',
              name: 'Lihi Segev',
              email: 'lihis@qualitestgroup.com',
              department: 'Account Management and Delivery',
              designation: 'Executive Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            },
            {
              ldap: 'a.bagade',
              name: 'Abhijeet Bagade',
              email: 'a.bagade@qualitestgroup.com',
              department: 'Account Management and Delivery',
              designation: 'Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            },
            {
              ldap: 'omrinis',
              name: 'Omri Nissim',
              email: 'omrinis@qualitestgroup.com',
              department: 'Account Management and Delivery',
              designation: 'Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            },
            {
              ldap: 'kobi.kol',
              name: 'Kobi Kol',
              email: 'kobi.kol@qualitestgroup.com',
              department: 'Account Management and Delivery',
              designation: 'Associate Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            },
            {
              ldap: 'jillian.orrico',
              name: 'Jillian OrRico',
              email: 'jillian.orrico@qualitestgroup.com',
              department: 'Sales',
              designation: 'Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            },
            {
              ldap: 'michael.bush',
              name: 'Michael Bush',
              email: 'michael.bush@qualitestgroup.com',
              department: 'Account Management and Delivery',
              designation: 'Associate Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            },
            {
              ldap: 'mayank.arya',
              name: 'Mayank Arya',
              email: 'mayank.arya@qualitestgroup.com',
              department: 'Account Management and Delivery',
              designation: 'Associate Vice President',
              company: 'Qualitest',
              organisation: 'Qualitest',
              connections: []
            }
          ];

          console.log('ðŸ”§ Using sample data');
        }

        console.log('ðŸ“‹ Final loaded data summary:');
        console.log(`- Google employees: ${googleEmployees.length}`);
        console.log(`- QT team: ${coreTeam.length}`);
      }

      // ADDED: Helper function to generate initials from name
      function getInitials(name) {
        if (!name) return 'NA';
        return name
          .split(' ')
          .map(word => word.charAt(0).toUpperCase())
          .join('')
          .substring(0, 2); // Take only first 2 initials
      }

      // ADDED: Helper function to check if image URL is valid
      function isValidImageUrl(url) {
        return url && url.trim() !== '' && (url.startsWith('http://') || url.startsWith('https://'));
      }

      function updateEmployeeMap() {
        employeeMap.clear();
        googleEmployees.forEach((e) => employeeMap.set(e.ldap, e));
        coreTeam.forEach((e) => employeeMap.set(e.ldap, e));
      }

      function createEmployeeCard(employee, className = "", connectionStrength = null) {
        if (!employee) return document.createElement("div");

        // Connection strength badge
        let strengthBadge = "";
        if (connectionStrength) {
          strengthBadge = `<div class="connection-badge badge-${connectionStrength}">
                            ${connectionStrength.charAt(0).toUpperCase() + connectionStrength.slice(1)}
                         </div>`;
        }

        const card = document.createElement("div");
        const borderClass = employee.company === "GOOGLE" ? "google-border" : "qt-border";
        card.className = `unified-card ${borderClass} ${className}`;
        
        // FIXED: Show avatar for Google employees using MOMA Photo URL or initials fallback
        let avatarHtml = '';
        if (employee.company === "GOOGLE") {
          if (isValidImageUrl(employee.avatar)) {
            // Use actual photo from MOMA Photo URL
            avatarHtml = `<img src="${employee.avatar}" alt="${employee.name}" class="w-14 h-14 rounded-full mb-2 border-2 border-white shadow object-cover" onError="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="w-14 h-14 rounded-full mb-2 border-2 border-white shadow bg-blue-500 text-white flex items-center justify-center font-bold text-lg" style="display:none;">
                           ${getInitials(employee.name)}
                         </div>`;
          } else {
            // Use initials as fallback
            avatarHtml = `<div class="w-14 h-14 rounded-full mb-2 border-2 border-white shadow bg-blue-500 text-white flex items-center justify-center font-bold text-lg">
                           ${getInitials(employee.name)}
                         </div>`;
          }
        }
        
        card.innerHTML = `
            ${strengthBadge}
            <div class="flex-1 flex flex-col items-center text-center justify-center">
                ${avatarHtml}
                <p class="text-[11px] font-semibold uppercase tracking-wider text-gray-500">${employee.organisation || employee.company}</p>
                <h4 class="font-bold text-sm text-gray-800">${employee.name}</h4>
                <p class="text-xs text-gray-500">${employee.designation}</p>
                <p class="text-[10px] text-gray-400 mt-1 font-mono">${employee.ldap}</p>
            </div>
        `;
        return card;
      }

      function createConnectionTooltip(path, onExpand) {
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip flex justify-center";
        
        // FIXED: Calculate actual connection steps - path length minus 1 (since path includes both endpoints)
        let connectionSteps = 1; // Default to 1 step for direct connection
        if (path && Array.isArray(path) && path.length > 0) {
          connectionSteps = Math.max(1, path.length - 1); // Steps = nodes - 1
        }
        
        console.log('Connection path:', path, 'Steps calculated:', connectionSteps);

        tooltip.innerHTML = `
                <button class="btn connection-btn">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span class="connection-count">${connectionSteps}</span>
                </button>
                <div class="tooltip-content">
                    <div class="space-y-2">
                        <p class="text-sm font-semibold">
                            Connection Path (${connectionSteps} ${connectionSteps === 1 ? "step" : "steps"})
                        </p>
                        <p class="text-xs muted italic pt-1">
                            Click to expand full hierarchy path.
                        </p>
                    </div>
                </div>
            `;

        tooltip.querySelector("button").addEventListener("click", onExpand);
        return tooltip;
      }

      // Enhanced hierarchy rendering with proper organizational structure
      async function renderHierarchyChart(employee) {
        console.log('ðŸŽ¯ renderHierarchyChart called for:', employee.name, employee.ldap);
        
        // Build organizational hierarchy for all employees
        const allEmployees = [...googleEmployees, ...coreTeam];
        const orgHierarchy = buildOrganizationalHierarchy(allEmployees);
        
        // Build the management chain for the selected employee
        const managementChain = buildManagementChain(employee, orgHierarchy);
        console.log('ðŸ“Š Management chain for', employee.name, ':', managementChain.map(emp => emp.name));
        
        const content = document.createElement("div");
        content.className = "space-y-0";

        // Show the full management hierarchy
        if (managementChain.length > 1) {
          content.innerHTML = `
            <div class="text-center text-sm font-semibold text-gray-600 mb-6">Organizational Hierarchy for ${employee.name}</div>
          `;

          // Create hierarchy visualization
          const hierarchyContainer = document.createElement("div");
          hierarchyContainer.className = "flex flex-col items-center space-y-4";

          managementChain.forEach((chainEmployee, index) => {
            // Create employee card
            const isSelectedEmployee = chainEmployee.ldap === employee.ldap;
            const cardClass = isSelectedEmployee ? "ring-2 ring-blue-500" : "";
            const card = createEmployeeCard(chainEmployee, cardClass);
            
            // Add level indicator
            const levelIndicator = document.createElement("div");
            levelIndicator.className = "text-xs text-gray-500 mb-2 text-center";
            if (index === 0 && managementChain.length > 1) {
              levelIndicator.textContent = "Top Manager";
            } else if (isSelectedEmployee) {
              levelIndicator.textContent = "Selected Employee";
            } else {
              levelIndicator.textContent = `Manager Level ${managementChain.length - index - 1}`;
            }
            
            const cardContainer = document.createElement("div");
            cardContainer.className = "flex flex-col items-center";
            cardContainer.appendChild(levelIndicator);
            cardContainer.appendChild(card);
            
            hierarchyContainer.appendChild(cardContainer);

            // Add connector line (except for last item)
            if (index < managementChain.length - 1) {
              const connector = document.createElement("div");
              connector.className = "flex flex-col items-center";
              connector.innerHTML = `
                <div class="w-px h-6 bg-gray-300"></div>
                <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                  Reports to
                </div>
                <div class="w-px h-6 bg-gray-300"></div>
              `;
              hierarchyContainer.appendChild(connector);
            }
          });

          content.appendChild(hierarchyContainer);

          // FIXED: Show direct reports with just total count, no individual cards
          const selectedNode = orgHierarchy.get(employee.ldap);
          if (selectedNode && selectedNode.reportees.length > 0) {
            const reportsSection = document.createElement("div");
            reportsSection.className = "mt-8 pt-6 border-t border-gray-200";
            
            // Just show the count summary, no individual cards
            const reportsContainer = document.createElement("div");
            reportsContainer.className = "text-center";
            
            const reportsTitle = document.createElement("div");
            reportsTitle.className = "text-lg font-semibold text-gray-700 mb-4 text-center";
            reportsTitle.textContent = `${employee.name} manages ${selectedNode.reportees.length} direct reports`;
            
            // Group by department for breakdown
            const departmentGroups = {};
            selectedNode.reportees.forEach(reporteeNode => {
              const dept = reporteeNode.employee.organisation || reporteeNode.employee.company || 'Other';
              if (!departmentGroups[dept]) {
                departmentGroups[dept] = [];
              }
              departmentGroups[dept].push(reporteeNode);
            });

            // Show department breakdown if multiple departments
            if (Object.keys(departmentGroups).length > 1) {
              const breakdown = document.createElement("div");
              breakdown.className = "mt-4 bg-gray-50 rounded-lg p-4 max-w-md mx-auto";
              
              const breakdownTitle = document.createElement("div");
              breakdownTitle.className = "text-sm font-medium text-gray-600 mb-3 text-center";
              breakdownTitle.textContent = "Team Breakdown:";
              breakdown.appendChild(breakdownTitle);

              Object.entries(departmentGroups).forEach(([dept, members]) => {
                const deptLine = document.createElement("div");
                deptLine.className = "flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0";
                deptLine.innerHTML = `
                  <span class="text-sm text-gray-700">${dept}</span>
                  <span class="text-sm font-semibold text-gray-900">${members.length} ${members.length === 1 ? 'person' : 'people'}</span>
                `;
                breakdown.appendChild(deptLine);
              });
              
              reportsContainer.appendChild(breakdown);
            }
            
            reportsSection.appendChild(reportsTitle);
            reportsSection.appendChild(reportsContainer);
            content.appendChild(reportsSection);
          }

          // Show QT connections section
          const qtConnectionsSection = await renderQTConnections(employee);
          content.appendChild(qtConnectionsSection);

        } else {
          // Single employee with no manager hierarchy
          content.innerHTML = `
            <div class="flex justify-center">${createEmployeeCard(employee).outerHTML}</div>
            <div class="text-center text-sm text-gray-500 mt-4">No manager hierarchy found</div>
          `;
          
          // Still show QT connections
          const qtConnectionsSection = await renderQTConnections(employee);
          content.appendChild(qtConnectionsSection);
        }
        
        console.log('ðŸ“‹ Organizational hierarchy rendering complete');
        return content;
      }

      // Helper function to build management chain from employee to top
      function buildManagementChain(employee, orgHierarchy) {
        const chain = [];
        let currentNode = orgHierarchy.get(employee.ldap);
        
        // Start with the employee
        if (currentNode) {
          chain.push(currentNode.employee);
          
          // Walk up the management chain
          while (currentNode.manager) {
            currentNode = currentNode.manager;
            chain.unshift(currentNode.employee); // Add to beginning to show top-down
          }
        } else {
          // Fallback if employee not found in hierarchy
          chain.push(employee);
        }
        
        return chain;
      }

      // Separate function to render QT connections (maintains existing UI)
      async function renderQTConnections(employee) {
        let connections = [];
        
        // First try to get real connections from Flask API (from Connections sheet)
        try {
          const response = await fetch(`/api/connections/${encodeURIComponent(employee.ldap)}`);
          if (response.ok) {
            connections = await response.json();
            console.log('âœ… Got real QT connections from API:', connections.length);
          }
        } catch (error) {
          console.log('âš ï¸ API connections failed:', error);
        }

        // Also try to get connections from the dedicated connections endpoint
        if (connections.length === 0) {
          try {
            const response = await fetch(`/api/connections-from-sheets`);
            if (response.ok) {
              const sheetsData = await response.json();
              // Filter connections for this specific employee
              const employeeConnections = sheetsData.connections.filter(conn => 
                conn['Google Employee LDAP'] === employee.ldap || 
                conn['Google Employee Email'] === employee.email ||
                conn['Google Employee Name'] === employee.name
              );
              
              // Convert sheet data to our connection format
              connections = employeeConnections.map(conn => ({
                qtLdap: conn['QT Employee LDAP'],
                qtName: conn['QT Employee Name'],
                qtEmail: conn['QT Employee Email'],
                connectionStrength: conn['Connection Strength']?.toLowerCase() || 'medium',
                path: [conn['QT Employee LDAP'], employee.ldap],
                declaredBy: conn['Declared By'],
                timestamp: conn['Timestamp']
              }));
              
              console.log('âœ… Got connections from Connections sheet:', connections.length);
            }
          } catch (error) {
            console.log('âš ï¸ Connections sheet API failed:', error);
          }
        }

        const qtSection = document.createElement("div");
        qtSection.className = "mt-8 pt-6 border-t border-gray-200";

        if (connections.length > 0) {
          qtSection.innerHTML = `
            <div class="text-center text-sm font-semibold text-gray-600 mb-4">
              QT Team Connections (${connections.length} declared)
            </div>
          `;

          // Create Swiper for QT connections (maintaining existing UI)
          const swiperContainer = document.createElement("div");
          swiperContainer.className = "summary-swiper swiper";
          swiperContainer.innerHTML = `<div class="swiper-wrapper"></div>`;
          const swiperWrapper = swiperContainer.querySelector(".swiper-wrapper");

          connections.forEach((conn) => {
            // Find or create QT employee using helper function
            const qtEmployee = findQTEmployee(conn.qtLdap, conn.qtName, conn.qtEmail);
            
            // Normalize connection strength
            const connectionStrength = normalizeConnectionStrength(conn.connectionStrength);

            // FIXED: Calculate proper connection path with actual intermediate steps
            const connectionDiv = document.createElement("div");
            connectionDiv.className = "flex flex-col items-center gap-0";

            const topLine = document.createElement("div");
            topLine.className = "w-px h-4 bg-gray-300";
            
            // Calculate actual connection path - for direct QT to Google connection, it should be 1 step
            // If there are intermediaries, count them properly
            let actualPath;
            if (conn.path && conn.path.length > 0) {
              actualPath = conn.path;
            } else {
              // Direct connection: QT person -> Google person (1 step)
              actualPath = [conn.qtLdap, employee.ldap];
            }
            
            console.log('QT Connection - qtLdap:', conn.qtLdap, 'googleLdap:', employee.ldap, 'path:', actualPath);
            
            const tooltip = createConnectionTooltip(
              actualPath, 
              () => {
                console.log('ðŸ”— Real connection clicked for:', qtEmployee.name, 'Strength:', connectionStrength, 'Path:', actualPath);
                showExpandedHierarchy(qtEmployee, actualPath, connectionStrength);
              }
            );
            
            const bottomLine = document.createElement("div");
            bottomLine.className = "w-px h-4 bg-gray-300";
            
            const card = createEmployeeCard(qtEmployee, "", connectionStrength);

            // Add connection metadata if available (from Connections sheet)
            if (conn.timestamp || conn.declaredBy) {
              const metadata = document.createElement("div");
              metadata.className = "text-xs text-gray-400 text-center mt-2 px-2 max-w-full overflow-hidden";
              let metadataText = "";
              if (conn.declaredBy && conn.declaredBy !== 'System') {
                metadataText += `Declared by: ${conn.declaredBy}`;
              }
              if (conn.timestamp) {
                const date = new Date(conn.timestamp);
                if (!isNaN(date.getTime())) {
                  metadataText += (metadataText ? ' â€¢ ' : '') + date.toLocaleDateString();
                }
              }
              if (metadataText) {
                metadata.textContent = metadataText;
                card.appendChild(metadata);
              }
            }

            connectionDiv.appendChild(topLine);
            connectionDiv.appendChild(tooltip);
            connectionDiv.appendChild(bottomLine);
            connectionDiv.appendChild(card);

            const slide = document.createElement("div");
            slide.className = "swiper-slide";
            slide.appendChild(connectionDiv);
            swiperWrapper.appendChild(slide);
          });

          qtSection.appendChild(swiperContainer);

          // Initialize Swiper for QT connections
          if (summarySwiperInstance) {
            summarySwiperInstance.destroy();
          }

          setTimeout(() => {
            summarySwiperInstance = new Swiper(".summary-swiper", {
              spaceBetween: 16,
              loop: connections.length > 3, // Only loop if we have more than 3 connections
              slidesPerView: 1,
              centeredSlides: true,
              breakpoints: {
                640: { slidesPerView: Math.min(2, connections.length), centeredSlides: false },
                1024: { slidesPerView: Math.min(3, connections.length), centeredSlides: false },
                1280: { slidesPerView: Math.min(4, connections.length), centeredSlides: false },
              },
            });
          }, 0);
        } else {
          qtSection.innerHTML = `
            <div class="text-center text-sm font-semibold text-gray-600 mb-4">QT Team Connections</div>
            <div class="text-center muted py-4">
              <p>No declared connections found for this employee.</p>
              <p class="text-xs mt-2">Connections can be declared in the <a href="/declare" class="text-blue-500 hover:underline">Declare page</a>.</p>
            </div>
          `;
        }

        return qtSection;
      }

      // Helper function to normalize connection strength values
      function normalizeConnectionStrength(strength) {
        if (!strength) return 'medium';
        const normalized = strength.toLowerCase().trim();
        if (['strong', 'medium', 'weak'].includes(normalized)) {
          return normalized;
        }
        return 'medium'; // Default fallback
      }

      // Helper function to find QT employee from various sources
      function findQTEmployee(qtLdap, qtName, qtEmail) {
        // First try to find in coreTeam
        let qtEmployee = coreTeam.find((e) => 
          e.ldap === qtLdap || 
          e.email === qtEmail || 
          e.name === qtName
        );
        
        if (qtEmployee) {
          return qtEmployee;
        }
        
        // Create from connection data if we have names
        if (qtName && qtLdap) {
          return {
            ldap: qtLdap,
            name: qtName,
            email: qtEmail || `${qtLdap}@qualitestgroup.com`,
            company: "QT",
            designation: "QT Team Member",
            organisation: "QT",
            avatar: `https://i.pravatar.cc/150?u=${qtLdap}`
          };
        }
        
        // Fallback creation from LDAP only
        const name = qtLdap.split('.').map(s => 
          s.charAt(0).toUpperCase() + s.slice(1)
        ).join(' ');
        
        return {
          ldap: qtLdap,
          name: name,
          company: "QT",
          designation: "QT Team Member",
          organisation: "QT",
          avatar: `https://i.pravatar.cc/150?u=${qtLdap}`
        };
      }

      function normalizeManagerReference(manager) {
        if (!manager) return null;
        
        // If it's an email, extract LDAP
        if (manager.includes('@')) {
          return manager.split('@')[0];
        }
        
        return manager;
      }

      // Helper function to build proper organizational hierarchy
      function buildOrganizationalHierarchy(employees) {
        const hierarchy = new Map();
        const employeesByLdap = new Map();
        
        // First pass: index all employees by LDAP
        employees.forEach(emp => {
          employeesByLdap.set(emp.ldap, emp);
          hierarchy.set(emp.ldap, {
            employee: emp,
            manager: null,
            reportees: []
          });
        });
        
        // Second pass: build manager-reportee relationships
        employees.forEach(emp => {
          const normalizedManager = normalizeManagerReference(emp.manager);
          if (normalizedManager && employeesByLdap.has(normalizedManager)) {
            const empNode = hierarchy.get(emp.ldap);
            const managerNode = hierarchy.get(normalizedManager);
            
            if (empNode && managerNode) {
              empNode.manager = managerNode;
              managerNode.reportees.push(empNode);
            }
          }
        });
        
        return hierarchy;
      }

      // Helper function to find connection path through organizational hierarchy
      function findOrganizationalPath(fromLdap, toLdap, orgHierarchy) {
        // If direct connection exists, return it
        if (fromLdap === toLdap) return [fromLdap];
        
        // Find common manager or build path up the hierarchy
        const fromNode = orgHierarchy.get(fromLdap);
        const toNode = orgHierarchy.get(toLdap);
        
        if (!fromNode || !toNode) return [fromLdap, toLdap]; // Fallback
        
        // Check if they have a direct reporting relationship
        if (fromNode.manager?.employee.ldap === toLdap) {
          return [fromLdap, toLdap];
        }
        if (toNode.manager?.employee.ldap === fromLdap) {
          return [fromLdap, toLdap];
        }
        
        // Check if they're peers (same manager)
        if (fromNode.manager?.employee.ldap === toNode.manager?.employee.ldap && fromNode.manager) {
          return [fromLdap, fromNode.manager.employee.ldap, toLdap];
        }
        
        // For now, return simple path - can be enhanced for deeper hierarchy traversal
        return [fromLdap, toLdap];
      }

      function getEmployeeName(path, fallbackEmployee) {
        if (!path || path.length === 0) {
          return fallbackEmployee?.name || 'Employee';
        }
        
        const targetLdap = path[path.length - 1];
        const targetEmployee = employeeMap.get(targetLdap);
        
        if (targetEmployee) {
          return targetEmployee.name;
        }
        
        // If not found in map, return the LDAP or fallback
        return targetLdap || fallbackEmployee?.name || 'Employee';
      }

      // Helper function to safely get employees from path
      function getPathEmployees(path) {
        if (!path || path.length === 0) return [];
        
        return path.map((ldap) => {
          const employee = employeeMap.get(ldap);
          if (employee) {
            return employee;
          }
          
          // Create a fallback employee object if not found in map
          console.warn(`Employee with LDAP ${ldap} not found in employeeMap, creating fallback`);
          return {
            ldap: ldap,
            name: ldap.charAt(0).toUpperCase() + ldap.slice(1),
            company: ldap.includes('@google.com') ? 'GOOGLE' : 'QT',
            designation: 'Unknown',
            organisation: 'Unknown',
            avatar: `https://i.pravatar.cc/150?u=${ldap}`,
            manager: null
          };
        }).filter(Boolean);
      }

      function renderExpandedHierarchy(qtEmployee, path, connectionStrength) {
        console.log('ðŸ“Š renderExpandedHierarchy called with:', qtEmployee.name, 'path:', path);
        
        const content = document.createElement("div");
        content.className = "space-y-6";

        content.innerHTML = `
                <div class="flex justify-center">
                    <button id="backBtn" class="bg-white border border-gray-300 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-gray-50">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>Back to Connections View
                    </button>
                </div>
                <div class="text-center">
                    <h2 class="text-xl font-bold">Connection Path</h2>
                    <p class="muted mt-1">From ${qtEmployee.name} to ${getEmployeeName(path, selectedEmployee)}</p>
                </div>
            `;

        // Use organizational hierarchy for better visualization
        const allEmployees = [...googleEmployees, ...coreTeam];
        const orgHierarchy = buildOrganizationalHierarchy(allEmployees);
        
        // Get path employees safely
        const pathEmployees = getPathEmployees(path);
        
        if (pathEmployees.length === 0) {
          console.error('No valid employees found in path');
          content.innerHTML += '<div class="text-center muted py-8"><p>Error: No valid employees found in connection path.</p></div>';
          
          content.querySelector("#backBtn").addEventListener("click", () => {
            expandedConnection = null;
            showSelectedEmployee();
          });
          
          return content;
        }

        // Enhanced visualization based on actual organizational structure
        const hierarchyContainer = document.createElement("div");
        hierarchyContainer.className = "flex flex-col items-center space-y-6 py-8";

        // Show QT employee at top with badge
        const qtCardContainer = document.createElement("div");
        qtCardContainer.className = "relative";
        const qtCard = createEmployeeCard(qtEmployee, "", connectionStrength);
        qtCardContainer.appendChild(qtCard);
        hierarchyContainer.appendChild(qtCardContainer);

        // Connection visualization
        const connectionSection = document.createElement("div");
        connectionSection.className = "flex flex-col items-center space-y-4";

        // Connection strength indicator
        const strengthIndicator = document.createElement("div");
        strengthIndicator.className = "flex items-center space-x-2";
        strengthIndicator.innerHTML = `
          <div class="w-8 h-1 bg-gray-300"></div>
          <div class="px-3 py-1 rounded-full text-xs font-semibold ${
            connectionStrength === 'strong' ? 'bg-green-100 text-green-800' :
            connectionStrength === 'medium' ? 'bg-yellow-100 text-yellow-800' :
            'bg-red-100 text-red-800'
          }">
            ${connectionStrength ? connectionStrength.charAt(0).toUpperCase() + connectionStrength.slice(1) : 'Direct'} Connection
          </div>
          <div class="w-8 h-1 bg-gray-300"></div>
        `;
        connectionSection.appendChild(strengthIndicator);

        // Path visualization
        if (pathEmployees.length > 2) {
          // Multi-step path
          const pathContainer = document.createElement("div");
          pathContainer.className = "flex flex-col items-center space-y-4";
          
          for (let i = 1; i < pathEmployees.length - 1; i++) {
            const intermediateEmployee = pathEmployees[i];
            const intermediateCard = createEmployeeCard(intermediateEmployee, "opacity-75 scale-90");
            
            const stepIndicator = document.createElement("div");
            stepIndicator.className = "text-xs text-gray-500 mb-2";
            stepIndicator.textContent = `Via: ${intermediateEmployee.designation}`;
            
            pathContainer.appendChild(stepIndicator);
            pathContainer.appendChild(intermediateCard);
            
            if (i < pathEmployees.length - 2) {
              const connector = document.createElement("div");
              connector.className = "w-px h-6 bg-gray-300";
              pathContainer.appendChild(connector);
            }
          }
          
          connectionSection.appendChild(pathContainer);
        }

        hierarchyContainer.appendChild(connectionSection);

        // Show target employee at bottom
        const targetEmployee = pathEmployees[pathEmployees.length - 1];
        const targetCard = createEmployeeCard(targetEmployee);
        hierarchyContainer.appendChild(targetCard);

        // Show organizational context if available
        const targetNode = orgHierarchy.get(targetEmployee.ldap);
        if (targetNode && targetNode.reportees.length > 0) {
          const teamSection = document.createElement("div");
          teamSection.className = "mt-8 pt-6 border-t border-gray-200 w-full";
          
          const teamTitle = document.createElement("div");
          teamTitle.className = "text-center text-sm font-semibold text-gray-600 mb-4";
          teamTitle.textContent = `${targetEmployee.name}'s Team (${targetNode.reportees.length} direct reports)`;
          teamSection.appendChild(teamTitle);
          
          const teamGrid = document.createElement("div");
          teamGrid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 justify-items-center";
          
          targetNode.reportees.slice(0, 6).forEach(reporteeNode => {
            const reporteeCard = createEmployeeCard(reporteeNode.employee, "scale-75 opacity-90");
            teamGrid.appendChild(reporteeCard);
          });
          
          if (targetNode.reportees.length > 6) {
            const moreIndicator = document.createElement("div");
            moreIndicator.className = "text-center text-sm text-gray-500 mt-2";
            moreIndicator.textContent = `... and ${targetNode.reportees.length - 6} more`;
            teamSection.appendChild(moreIndicator);
          }
          
          teamSection.appendChild(teamGrid);
          hierarchyContainer.appendChild(teamSection);
        }

        content.appendChild(hierarchyContainer);

        // Add back button functionality
        content.querySelector("#backBtn").addEventListener("click", () => {
          console.log('ðŸ”™ Back button clicked');
          expandedConnection = null;
          showSelectedEmployee();
        });

        console.log('âœ… Enhanced hierarchy rendered with organizational structure');
        return content;
      }

      // --- CORE LOGIC & HELPERS ---

      async function getConnections(employee) {
        try {
          // First try to get connections from API
          const response = await fetch(`/api/connections/${encodeURIComponent(employee.ldap)}`);
          if (response.ok) {
            const connections = await response.json();
            console.log('API connections for', employee.name, ':', connections);
            if (connections && connections.length > 0) {
              return connections;
            }
          }
        } catch (error) {
          console.log('API connections failed, using computed paths:', error);
        }
        
        // Fallback to computed connection paths
        const computed = connectionPaths[employee.ldap] || [];
        console.log('Computed connections for', employee.name, ':', computed);
        return computed;
      }

      function showExpandedHierarchy(qtEmployee, path, connectionStrength) {
        expandedConnection = { qtEmployee, path, connectionStrength };
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = "";
        mainContent.appendChild(renderExpandedHierarchy(qtEmployee, path, connectionStrength));
        lucide.createIcons();
      }

      async function showSelectedEmployee() {
        if (!selectedEmployee) return;
        const mainContent = document.getElementById("mainContent");
        
        // Show loading state
        mainContent.innerHTML = '<div class="text-center py-16"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div><p class="mt-4 text-gray-500">Loading hierarchy...</p></div>';

        try {
          if (expandedConnection) {
            mainContent.innerHTML = "";
            mainContent.appendChild(renderExpandedHierarchy(expandedConnection.qtEmployee, expandedConnection.path, expandedConnection.connectionStrength));
          } else {
            console.log('Showing selected employee:', selectedEmployee.name, selectedEmployee.ldap);
            const hierarchyContent = await renderHierarchyChart(selectedEmployee);
            mainContent.innerHTML = "";
            mainContent.appendChild(hierarchyContent);
          }
          lucide.createIcons();
        } catch (error) {
          console.error('Error showing selected employee:', error);
          mainContent.innerHTML = `
            <div class="text-center py-16">
              <p class="text-red-500">Error loading employee hierarchy</p>
              <p class="text-sm text-gray-500 mt-2">${error.message}</p>
            </div>`;
        }
      }

      function setupSearch() {
        const searchInput = document.getElementById("searchInput");
        const suggestions = document.getElementById("suggestions");

        searchInput.addEventListener("input", async (e) => {
          const searchTerm = e.target.value.toLowerCase();
          console.log('Searching for:', searchTerm);
          
          // ADDED: Clear selection and reset to original state when search is cleared
          if (searchTerm.length === 0) {
            suggestions.classList.add("hidden");
            selectedEmployee = null;
            expandedConnection = null;
            resetToOriginalState();
            return;
          }

          // Try API search first
          let filtered = [];
          try {
            const response = await fetch(`/api/search-google-employees?q=${encodeURIComponent(searchTerm)}`);
            if (response.ok) {
              const apiResults = await response.json();
              if (apiResults && apiResults.length > 0) {
                // FIXED: Show more API results (increased from 5 to 15)
                filtered = apiResults.slice(0, 15);
                console.log('API search results:', filtered.length);
              }
            }
          } catch (error) {
            console.log('API search failed, using local search');
          }

          // Fallback to local search if API failed or no results
          if (filtered.length === 0) {
            // FIXED: Enhanced search to find more matches and increased limit
            filtered = googleEmployees
              .filter(
                (emp) =>
                  // Search in name (both first and last name parts)
                  emp.name.toLowerCase().includes(searchTerm) || 
                  // Search in individual name parts (for cases like "Ehud Persitz")
                  emp.name.toLowerCase().split(' ').some(part => part.includes(searchTerm)) ||
                  // Search in LDAP
                  emp.ldap.toLowerCase().includes(searchTerm) || 
                  // Search in designation
                  emp.designation.toLowerCase().includes(searchTerm) ||
                  // Search in email
                  (emp.email && emp.email.toLowerCase().includes(searchTerm)) ||
                  // Search in organisation
                  (emp.organisation && emp.organisation.toLowerCase().includes(searchTerm))
              )
              // FIXED: Increased from 10 to 20 results to show more matches
              .slice(0, 20);
            console.log('Local search results:', filtered.length, 'for term:', searchTerm);
          }

          suggestions.innerHTML = "";
          if (filtered.length > 0) {
            filtered.forEach((employee) => {
              const item = document.createElement("button");
              item.className = "suggestion-item";
              
              // FIXED: Use proper avatar or initials in search suggestions
              let suggestionAvatarHtml;
              if (isValidImageUrl(employee.avatar)) {
                suggestionAvatarHtml = `<img src="${employee.avatar}" alt="${employee.name}" class="w-8 h-8 rounded-full object-cover" onError="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                       <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs" style="display:none;">
                                         ${getInitials(employee.name)}
                                       </div>`;
              } else {
                suggestionAvatarHtml = `<div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">
                                         ${getInitials(employee.name)}
                                       </div>`;
              }
              
              item.innerHTML = `
                            ${suggestionAvatarHtml}
                            <div>
                                <div>${employee.name}</div>
                                <div class="text-sm muted">${employee.designation}</div>
                                <div class="text-sm muted">${employee.ldap}</div>
                            </div>`;
              item.addEventListener("click", async () => {
                console.log('Selected employee:', employee.name, 'LDAP:', employee.ldap);
                searchInput.value = employee.name;
                suggestions.classList.add("hidden");
                selectedEmployee = employee;
                expandedConnection = null;
                await showSelectedEmployee();
              });
              suggestions.appendChild(item);
            });
            suggestions.classList.remove("hidden");
          } else {
            console.log('No search results found');
            suggestions.classList.add("hidden");
          }
        });
        
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".relative")) suggestions.classList.add("hidden");
        });
      }

      // ADDED: Function to reset page to original state
      function resetToOriginalState() {
        console.log('ðŸ”„ Resetting to original state');
        const mainContent = document.getElementById("mainContent");
        
        // Destroy any existing Swiper instances
        if (summarySwiperInstance) {
          summarySwiperInstance.destroy();
          summarySwiperInstance = null;
        }
        
        // Reset to original welcome message
        mainContent.innerHTML = `
          <div class="text-center muted py-16">
            <p>Search and select a Google employee to view their hierarchy and connections.</p>
          </div>
        `;
        
        // Clear global state
        selectedEmployee = null;
        expandedConnection = null;
        
        console.log('âœ… Reset to original state complete');
      }

      // --- DATA PRE-COMPUTATION (For Demo) ---
      function precomputeAllPaths() {
        console.log('Computing connection paths...');
        console.log('Google employees:', googleEmployees.length);
        console.log('QT team:', coreTeam.length);

        // For each Google employee, find connections to QT team
        for (const targetEmployee of googleEmployees) {
          const targetLdap = targetEmployee.ldap;
          const pathsToTarget = [];

          console.log('Processing connections for:', targetEmployee.name, targetLdap);

          for (const qt of coreTeam) {
            console.log('Checking QT member:', qt.name, 'connections:', qt.connections);
            
            // Check if this QT member has any connections
            if (qt.connections && qt.connections.length > 0) {
              for (const conn of qt.connections) {
                console.log('Checking connection:', conn.ldap, 'against target:', targetLdap);
                
                // Direct connection match
                if (conn.ldap === targetLdap) {
                  console.log('MATCH FOUND! Direct connection from', qt.name, 'to', targetEmployee.name);
                  pathsToTarget.push({
                    qtLdap: qt.ldap,
                    path: [qt.ldap, targetLdap],
                    connectionStrength: conn.connectionStrength,
                    via: conn.ldap,
                  });
                }
              }
            }
          }

          if (pathsToTarget.length > 0) {
            console.log('Found', pathsToTarget.length, 'connections for', targetEmployee.name);
            connectionPaths[targetLdap] = pathsToTarget.sort((a, b) => a.path.length - b.path.length);
          } else {
            console.log('No connections found for', targetEmployee.name);
          }
        }

        console.log('Final connection paths:', connectionPaths);
      }

      async function init() {
        console.log('ðŸš€ Initializing application...');
        await loadFlaskData();
        updateEmployeeMap();
        
        // Debug data loading
        console.log('ðŸ“Š Data loaded:');
        console.log('- Google employees:', googleEmployees.length, googleEmployees.map(e => e.name));
        console.log('- QT team:', coreTeam.length, coreTeam.map(e => e.name));
        console.log('- QT connections:', coreTeam.map(e => ({ name: e.name, connections: e.connections })));
        
        precomputeAllPaths();
        
        // Debug connection paths
        console.log('ðŸ”— Connection paths computed:', Object.keys(connectionPaths).length);
        Object.entries(connectionPaths).forEach(([emp, conns]) => {
          if (conns.length > 0) {
            console.log(`- ${emp}: ${conns.length} connections`);
          }
        });
        
        setupSearch();
        lucide.createIcons();
        console.log('âœ… Initialization complete!');
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
