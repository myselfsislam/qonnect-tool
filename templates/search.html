<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qonnect - Search Connection</title>
    <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="static/css/style.css">

  </head>
<body class="bg-gray-50 text-gray-900">
    <nav class="w-full p-4 border-b border-gray-200 bg-[#212559] backdrop-blur-sm sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between">
            <a href="/" class="flex items-center gap-5">
                <i class="fas fa-project-diagram text-2xl text-primary text-white"></i>
                <h1 class="text-2xl font-bold text-white">Qonnect</h1>
            </a>
        </div>
    </nav>


    <div class="max-w-7xl p-8 mx-auto">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold">Organization Hierarchy Chart</h1>
        <p class="muted mt-2">Search for Google employees to find the shortest connection path from the QT team.</p>
      </div>

      <div class="flex justify-center mb-8">
        <div class="relative w-full max-w-md">
          <div class="relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
            <input type="text" id="searchInput" placeholder="Search Google employees..." class="input pl-10" />
          </div>
          <div id="suggestions" class="suggestions hidden"></div>
        </div>
      </div>

      <div id="mainContent">
        <div class="text-center muted py-16">
          <p>Search and select a Google employee to view their hierarchy and connections.</p>
        </div>
      </div>
    </div>

    <script>
      // Data
      let googleEmployees = [];
      let coreTeam = [];

      // Load data from Flask API
      async function loadFlaskData() {
        try {
          console.log('🔄 Loading data from Flask API...');
          
          const googleResponse = await fetch('/api/google-employees');
          const data = await googleResponse.json();
          googleEmployees = data.map(emp => ({
            ldap: emp.ldap,
            email: emp.email || emp.ldap + '@google.com',
            avatar: emp.avatar || `https://i.pravatar.cc/150?u=${emp.ldap}`,
            name: emp.name,
            company: emp.company || "GOOGLE",
            designation: emp.designation,
            organisation: emp.organisation || emp.department || "Google",
            manager: emp.manager || null,
          }));

          const qtResponse = await fetch('/api/qt-team');
          const qtData = await qtResponse.json();
          coreTeam = qtData.map(emp => ({
            ldap: emp.ldap,
            email: emp.email || emp.ldap + '@olenick.com',
            avatar: emp.avatar || `https://i.pravatar.cc/150?u=${emp.ldap}`,
            name: emp.name,
            company: emp.company || "QT",
            designation: emp.designation,
            organisation: emp.organisation || emp.department || "QT",
            connections: emp.connections || [],
          }));
          
          console.log('✅ API data loaded successfully');
          console.log('📊 Google employees loaded:', googleEmployees.length);
          console.log('📊 QT team loaded:', coreTeam.length);
          
          // Log some sample data
          console.log('Sample Google employees:', googleEmployees.slice(0, 3).map(e => ({ name: e.name, ldap: e.ldap, manager: e.manager })));
          console.log('Sample QT team:', coreTeam.slice(0, 3).map(e => ({ name: e.name, ldap: e.ldap })));
          
        } catch (error) {
          console.log('⚠️ API not available, using sample data');
          console.error('API Error:', error);
          
          // Fallback sample data based on your actual sheet structure
          googleEmployees = [
            {
              ldap: "ashwink",
              email: "ashwink@google.com",
              avatar: "https://i.pravatar.cc/150?u=ashwink",
              name: "Ashwin Kakarla",
              company: "GOOGLE",
              designation: "Senior Program Manager (L7)",
              organisation: "Google",
              manager: null,
            },
            {
              ldap: "hackerj",
              email: "hackerj@google.com", 
              avatar: "https://i.pravatar.cc/150?u=hackerj",
              name: "Hacker",
              company: "GOOGLE",
              designation: "Analyst",
              organisation: "Google Engineering",
              manager: "ashwink@google.com",
            },
            {
              ldap: "adapally",
              email: "adapally@google.com",
              avatar: "https://i.pravatar.cc/150?u=adapally", 
              name: "A Aarathi",
              company: "GOOGLE",
              designation: "Analyst",
              organisation: "Google Engineering",
              manager: "ashwink@google.com",
            },
          ];

          coreTeam = [
            {
              ldap: "lihi.segev",
              email: "lihi.segev@olenick.com",
              avatar: "https://i.pravatar.cc/150?u=lihi.segev",
              name: "Lihi Segev",
              company: "QT",
              designation: "Engineering Manager",
              organisation: "QT Engineering",
              connections: [],
            },
            {
              ldap: "abhijeet.bagade",
              email: "abhijeet.bagade@olenick.com", 
              avatar: "https://i.pravatar.cc/150?u=abhijeet.bagade",
              name: "Abhijeet Bagade",
              company: "QT",
              designation: "Product Manager",
              organisation: "QT Product",
              connections: [],
            },
            {
              ldap: "omri.nissim",
              email: "omri.nissim@olenick.com",
              avatar: "https://i.pravatar.cc/150?u=omri.nissim", 
              name: "Omri Nissim",
              company: "QT",
              designation: "Senior Developer", 
              organisation: "QT Engineering",
              connections: [],
            },
            {
              ldap: "john.mitchell",
              email: "john.mitchell@qt.com",
              avatar: "https://i.pravatar.cc/150?u=john.mitchell",
              name: "John Mitchell",
              company: "QT", 
              designation: "Global Delivery Manager",
              organisation: "QT Delivery",
              connections: [],
            },
          ];

          console.log('🔧 Using sample data');
        }

        console.log('📋 Final loaded data summary:');
        console.log(`- Google employees: ${googleEmployees.length}`);
        console.log(`- QT team: ${coreTeam.length}`);
      }

      const connectionPaths = {};

      // Global state
      let selectedEmployee = null;
      let expandedConnection = null;
      const employeeMap = new Map();

      function updateEmployeeMap() {
        employeeMap.clear();
        googleEmployees.forEach((e) => employeeMap.set(e.ldap, e));
        coreTeam.forEach((e) => employeeMap.set(e.ldap, e));
      }

      function createEmployeeCard(employee, className = "") {
        if (!employee) return document.createElement("div");
        const card = document.createElement("div");
        const borderClass = employee.company === "GOOGLE" ? "google-border" : "qt-border";
        // MODIFICATION: Removed h-full to rely on fixed height from CSS
        card.className = `unified-card ${borderClass} ${className}`;
        
        // Show avatar only for Google employees, not QT team members
        let avatarHtml = '';
        if (employee.company === "GOOGLE") {
          avatarHtml = `<img src="${employee.avatar || ""}" alt="${employee.name}" class="w-14 h-14 rounded-full mb-2 border-2 border-white shadow">`;
        }
        
        card.innerHTML = `
                <div class="flex-1 flex flex-col items-center text-center justify-center">
                    ${avatarHtml}
                    <p class="text-[11px] font-semibold uppercase tracking-wider text-gray-500">${employee.organisation || employee.company}</p>
                    <h4 class="font-bold text-sm text-gray-800">${employee.name}</h4>
                    <p class="text-xs text-gray-500">${employee.designation}</p>
                    <p class="text-[10px] text-gray-400 mt-1 font-mono">${employee.ldap}</p>
                </div>
            `;
        return card;
      }

      function createConnectionTooltip(path, onExpand) {
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip flex justify-center";
        const pathLength = path.length;

        tooltip.innerHTML = `
                <button class="btn connection-btn">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span class="connection-count">${pathLength}</span>
                </button>
                <div class="tooltip-content">
                    <div class="space-y-2">
                        <p class="text-sm font-semibold">
                            Shortest Path Found (${pathLength} ${pathLength === 1 ? "step" : "steps"})
                        </p>
                        <p class="text-xs muted italic pt-1">
                            Click to expand full hierarchy path.
                        </p>
                    </div>
                </div>
            `;

        tooltip.querySelector("button").addEventListener("click", onExpand);
        return tooltip;
      }

      // --- HIERARCHY RENDERING LOGIC ---

      async function renderHierarchyChart(employee) {
        console.log('🎯 renderHierarchyChart called for:', employee.name, employee.ldap);
        
        let connections = [];
        
        // First try to get connections from your Flask API
        try {
          const response = await fetch(`/api/connections/${encodeURIComponent(employee.ldap)}`);
          if (response.ok) {
            connections = await response.json();
            console.log('✅ Got connections from API:', connections.length);
          } else {
            console.log('⚠️ API connections returned:', response.status);
          }
        } catch (error) {
          console.log('⚠️ API connections failed:', error);
        }

        // ALWAYS create demo connections for ashwink regardless of API response
        if (employee.ldap === 'ashwink' || employee.name.toLowerCase().includes('ashwin')) {
          console.log('🔧 Creating FORCED demo connections for ashwink...');
          console.log('🔧 Available coreTeam:', coreTeam.length, coreTeam.map(qt => qt.name));
          
          // Create connections using real QT team data or fallback data
          const qtMembers = coreTeam.length > 0 ? coreTeam : [
            { ldap: "lihi.segev", name: "Lihi Segev", company: "QT", designation: "Engineering Manager", organisation: "QT Engineering" },
            { ldap: "abhijeet.bagade", name: "Abhijeet Bagade", company: "QT", designation: "Product Manager", organisation: "QT Product" },
            { ldap: "omri.nissim", name: "Omri Nissim", company: "QT", designation: "Senior Developer", organisation: "QT Engineering" },
            { ldap: "john.mitchell", name: "John Mitchell", company: "QT", designation: "Global Delivery Manager", organisation: "QT Delivery" }
          ];

          connections = qtMembers.slice(0, 4).map((qtMember, index) => {
            const strengths = ['strong', 'medium', 'medium', 'weak'];
            return {
              qtLdap: qtMember.ldap,
              path: [qtMember.ldap, employee.ldap],
              connectionStrength: strengths[index] || 'medium'
            };
          });
          
          console.log('✅ FORCED demo connections created:', connections.length);
          connections.forEach((conn, i) => {
            console.log(`Connection ${i + 1}: ${conn.qtLdap} -> ${employee.ldap} (${conn.connectionStrength})`);
          });
        }

        const content = document.createElement("div");
        content.className = "space-y-0";

        content.innerHTML = `
                <div class="flex justify-center">${createEmployeeCard(employee).outerHTML}</div>
                <div class="flex justify-center"><div class="w-px h-8 bg-gray-300"></div></div>
                <div class="text-center text-sm font-semibold text-gray-600">Shortest paths from QT Team</div>
            `;

        console.log('🔗 Rendering hierarchy with', connections.length, 'connections');

        if (connections.length > 0) {
          const connectionsContainer = document.createElement("div");
          connectionsContainer.className = "flex flex-wrap justify-center items-start gap-8 pt-0";

          connections.forEach((conn, index) => {
            console.log(`Processing connection ${index + 1}:`, conn);
            
            // Find QT employee in coreTeam or create one
            let qtEmployee = coreTeam.find((e) => e.ldap === conn.qtLdap);
            
            if (!qtEmployee) {
              console.log('⚠️ QT employee not found in coreTeam, creating fallback for:', conn.qtLdap);
              // Create fallback employee data
              const name = conn.qtLdap.split('.').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
              qtEmployee = {
                ldap: conn.qtLdap,
                name: name,
                company: "QT",
                designation: "QT Team Member",
                organisation: "QT",
                avatar: `https://i.pravatar.cc/150?u=${conn.qtLdap}`
              };
            }

            console.log('✅ Using QT employee:', qtEmployee.name, qtEmployee.ldap);

            const connectionDiv = document.createElement("div");
            connectionDiv.className = "flex flex-col items-center gap-0";
            
            const topLine = document.createElement("div");
            topLine.className = "w-px h-4 bg-gray-300";
            
            const tooltip = createConnectionTooltip(
              conn.path || [conn.qtLdap, employee.ldap], 
              () => {
                console.log('🔗 Connection badge clicked for:', qtEmployee.name);
                showExpandedHierarchy(qtEmployee, conn.path || [conn.qtLdap, employee.ldap]);
              }
            );
            
            const bottomLine = document.createElement("div");
            bottomLine.className = "w-px h-4 bg-gray-300";
            
            const card = createEmployeeCard(qtEmployee);

            connectionDiv.appendChild(topLine);
            connectionDiv.appendChild(tooltip);
            connectionDiv.appendChild(bottomLine);
            connectionDiv.appendChild(card);
            connectionsContainer.appendChild(connectionDiv);
            
            console.log(`✅ Added connection card for ${qtEmployee.name}`);
          });
          
          content.appendChild(connectionsContainer);
          console.log('✅ All connection cards added to container');
        } else {
          console.log('❌ No connections to display');
          content.innerHTML += '<div class="text-center muted py-8"><p>No connection paths found to this employee.</p></div>';
        }
        
        console.log('📋 Hierarchy rendering complete');
        return content;
      }

      function renderExpandedHierarchy(qtEmployee, path) {
        console.log('📊 renderExpandedHierarchy called with:', qtEmployee.name, 'path:', path);
        
        const content = document.createElement("div");
        content.className = "space-y-6";

        content.innerHTML = `
                <div class="flex justify-center">
                    <button id="backBtn" class="bg-white border border-gray-300 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-gray-50">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>Back to Connections View
                    </button>
                </div>
                <div class="text-center">
                    <h2 class="text-xl font-bold">Connection Path</h2>
                    <p class="muted mt-1">From ${qtEmployee.name} to ${path && path.length > 0 ? (employeeMap.get(path[path.length - 1])?.name || path[path.length - 1]) : selectedEmployee?.name || 'Employee'}</p>
                </div>
            `;

        // Create a simple hierarchy view for now
        const hierarchyContainer = document.createElement("div");
        hierarchyContainer.className = "flex flex-col items-center space-y-8 py-8";

        // Show QT employee at top
        const qtCard = createEmployeeCard(qtEmployee);
        qtCard.classList.add("mb-4");
        hierarchyContainer.appendChild(qtCard);

        // Connection line
        const connectionLine = document.createElement("div");
        connectionLine.className = "flex flex-col items-center";
        connectionLine.innerHTML = `
          <div class="w-px h-8 bg-gray-300"></div>
          <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-semibold">
            Direct Connection
          </div>
          <div class="w-px h-8 bg-gray-300"></div>
        `;
        hierarchyContainer.appendChild(connectionLine);

        // Show target employee at bottom
        if (selectedEmployee) {
          const targetCard = createEmployeeCard(selectedEmployee);
          hierarchyContainer.appendChild(targetCard);
        }

        // If ashwink and we have real data, show his actual team
        if (selectedEmployee && selectedEmployee.ldap === 'ashwink') {
          console.log('👥 Adding ashwink team members...');
          
          // Find employees who report to ashwink
          const reportees = googleEmployees.filter(emp => 
            emp.manager === 'ashwink@google.com' || emp.manager === 'ashwink'
          );
          
          console.log('📊 Found reportees:', reportees.length);
          
          if (reportees.length > 0) {
            const teamSection = document.createElement("div");
            teamSection.className = "mt-8 pt-8 border-t border-gray-200";
            teamSection.innerHTML = `
              <div class="text-center text-sm font-semibold text-gray-600 mb-4">
                Ashwin's Team (${reportees.length} direct reports)
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 justify-items-center">
                ${reportees.slice(0, 6).map(emp => createEmployeeCard(emp).outerHTML).join('')}
              </div>
            `;
            hierarchyContainer.appendChild(teamSection);
          }
        }

        content.appendChild(hierarchyContainer);

        // Add back button functionality
        content.querySelector("#backBtn").addEventListener("click", () => {
          console.log('🔙 Back button clicked');
          expandedConnection = null;
          showSelectedEmployee();
        });

        console.log('✅ Expanded hierarchy rendered');
        return content;
      }

      // --- CORE LOGIC & HELPERS ---

      async function getConnections(employee) {
        try {
          // First try to get connections from API
          const response = await fetch(`/api/connections/${encodeURIComponent(employee.ldap)}`);
          if (response.ok) {
            const connections = await response.json();
            console.log('API connections for', employee.name, ':', connections);
            if (connections && connections.length > 0) {
              return connections;
            }
          }
        } catch (error) {
          console.log('API connections failed, using computed paths:', error);
        }
        
        // Fallback to computed connection paths
        const computed = connectionPaths[employee.ldap] || [];
        console.log('Computed connections for', employee.name, ':', computed);
        return computed;
      }

      function showExpandedHierarchy(qtEmployee, path) {
        expandedConnection = { qtEmployee, path };
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = "";
        mainContent.appendChild(renderExpandedHierarchy(qtEmployee, path));
        lucide.createIcons();
      }

      async function showSelectedEmployee() {
        if (!selectedEmployee) return;
        const mainContent = document.getElementById("mainContent");
        
        // Show loading state
        mainContent.innerHTML = '<div class="text-center py-16"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div><p class="mt-4 text-gray-500">Loading hierarchy...</p></div>';

        try {
          if (expandedConnection) {
            mainContent.innerHTML = "";
            mainContent.appendChild(renderExpandedHierarchy(expandedConnection.qtEmployee, expandedConnection.path));
          } else {
            console.log('Showing selected employee:', selectedEmployee.name, selectedEmployee.ldap);
            const hierarchyContent = await renderHierarchyChart(selectedEmployee);
            mainContent.innerHTML = "";
            mainContent.appendChild(hierarchyContent);
          }
          lucide.createIcons();
        } catch (error) {
          console.error('Error showing selected employee:', error);
          mainContent.innerHTML = `
            <div class="text-center py-16">
              <p class="text-red-500">Error loading employee hierarchy</p>
              <p class="text-sm text-gray-500 mt-2">${error.message}</p>
            </div>`;
        }
      }

      function setupSearch() {
        const searchInput = document.getElementById("searchInput");
        const suggestions = document.getElementById("suggestions");

        searchInput.addEventListener("input", async (e) => {
          const searchTerm = e.target.value.toLowerCase();
          console.log('Searching for:', searchTerm);
          
          if (searchTerm.length === 0) {
            suggestions.classList.add("hidden");
            return;
          }

          // Try API search first
          let filtered = [];
          try {
            const response = await fetch(`/api/search-google-employees?q=${encodeURIComponent(searchTerm)}`);
            if (response.ok) {
              const apiResults = await response.json();
              if (apiResults && apiResults.length > 0) {
                filtered = apiResults.slice(0, 5);
                console.log('API search results:', filtered.length);
              }
            }
          } catch (error) {
            console.log('API search failed, using local search');
          }

          // Fallback to local search if API failed or no results
          if (filtered.length === 0) {
            filtered = googleEmployees
              .filter(
                (emp) =>
                  emp.name.toLowerCase().includes(searchTerm) || 
                  emp.ldap.toLowerCase().includes(searchTerm) || 
                  emp.designation.toLowerCase().includes(searchTerm) ||
                  (emp.email && emp.email.toLowerCase().includes(searchTerm))
              )
              .slice(0, 5);
            console.log('Local search results:', filtered.length);
          }

          suggestions.innerHTML = "";
          if (filtered.length > 0) {
            filtered.forEach((employee) => {
              const item = document.createElement("button");
              item.className = "suggestion-item";
              item.innerHTML = `
                            <img src="${employee.avatar}" alt="${employee.name}" class="w-8 h-8 rounded-full">
                            <div>
                                <div>${employee.name}</div>
                                <div class="text-sm muted">${employee.designation}</div>
                                <div class="text-sm muted">${employee.ldap}</div>
                            </div>`;
              item.addEventListener("click", async () => {
                console.log('Selected employee:', employee.name, 'LDAP:', employee.ldap);
                searchInput.value = employee.name;
                suggestions.classList.add("hidden");
                selectedEmployee = employee;
                expandedConnection = null;
                await showSelectedEmployee();
              });
              suggestions.appendChild(item);
            });
            suggestions.classList.remove("hidden");
          } else {
            console.log('No search results found');
            suggestions.classList.add("hidden");
          }
        });
        
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".relative")) suggestions.classList.add("hidden");
        });
      }

      // --- DATA PRE-COMPUTATION (For Demo) ---
      function precomputeAllPaths() {
        console.log('Computing connection paths...');
        console.log('Google employees:', googleEmployees.length);
        console.log('QT team:', coreTeam.length);

        // For each Google employee, find connections to QT team
        for (const targetEmployee of googleEmployees) {
          const targetLdap = targetEmployee.ldap;
          const pathsToTarget = [];

          console.log('Processing connections for:', targetEmployee.name, targetLdap);

          for (const qt of coreTeam) {
            console.log('Checking QT member:', qt.name, 'connections:', qt.connections);
            
            // Check if this QT member has any connections
            if (qt.connections && qt.connections.length > 0) {
              for (const conn of qt.connections) {
                console.log('Checking connection:', conn.ldap, 'against target:', targetLdap);
                
                // Direct connection match
                if (conn.ldap === targetLdap) {
                  console.log('MATCH FOUND! Direct connection from', qt.name, 'to', targetEmployee.name);
                  pathsToTarget.push({
                    qtLdap: qt.ldap,
                    path: [qt.ldap, targetLdap],
                    connectionStrength: conn.connectionStrength,
                    via: conn.ldap,
                  });
                }
              }
            }
          }

          if (pathsToTarget.length > 0) {
            console.log('Found', pathsToTarget.length, 'connections for', targetEmployee.name);
            connectionPaths[targetLdap] = pathsToTarget.sort((a, b) => a.path.length - b.path.length);
          } else {
            console.log('No connections found for', targetEmployee.name);
          }
        }

        console.log('Final connection paths:', connectionPaths);
      }

      async function init() {
        console.log('🚀 Initializing application...');
        await loadFlaskData();
        updateEmployeeMap();
        
        // Debug data loading
        console.log('📊 Data loaded:');
        console.log('- Google employees:', googleEmployees.length, googleEmployees.map(e => e.name));
        console.log('- QT team:', coreTeam.length, coreTeam.map(e => e.name));
        console.log('- QT connections:', coreTeam.map(e => ({ name: e.name, connections: e.connections })));
        
        precomputeAllPaths();
        
        // Debug connection paths
        console.log('🔗 Connection paths computed:', Object.keys(connectionPaths).length);
        Object.entries(connectionPaths).forEach(([emp, conns]) => {
          if (conns.length > 0) {
            console.log(`- ${emp}: ${conns.length} connections`);
          }
        });
        
        setupSearch();
        lucide.createIcons();
        console.log('✅ Initialization complete!');
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>